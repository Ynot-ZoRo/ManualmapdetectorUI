name: Build and Release WPF App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write   # Needed to create releases

jobs:
  build:
    runs-on: windows-latest

    steps:
    # ------------------------------
    # Checkout repo
    # ------------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ------------------------------
    # Setup .NET
    # ------------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # ------------------------------
    # Restore Packages
    # ------------------------------
    - name: Restore Dependencies
      run: dotnet restore ManualMapDetectorWPF.csproj

    # ------------------------------
    # Build
    # ------------------------------
    - name: Build Project
      run: dotnet build ManualMapDetectorWPF.csproj -c Release

    # ------------------------------
    # Publish EXE
    # ------------------------------
    - name: Publish App
      run: dotnet publish ManualMapDetectorWPF.csproj -c Release -r win-x64 --self-contained true -o ./publish

    # ------------------------------
    # Upload Build Artifact
    # ------------------------------
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ManualMapDetectorWPF-EXE
        path: ./publish/**

    # ------------------------------
    # Rate Limit Protection
    # (prevents “secondary rate limit” errors)
    # ------------------------------
    - name: Delay to avoid GitHub API rate limit
      run: timeout /t 15

    # ------------------------------
    # Create GitHub Release
    # ------------------------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: "ManualMapDetectorWPF Build ${{ github.run_number }}"
        files: publish/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
